---
title: "Introduction to cohort design with vaccineff"
bibliography: vignettes/references.json
link-citations: true
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vaccineff}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(vaccineff)
```

# Cohort Design

In the cohort design [@torvaldsen2002], $VE$ is estimated using the Hazard Ratios ($HR$) between vaccinated and unvaccinated populations,

$$VE = (1-HR(t))\times100.$$

The HR is estimated using the Cox Proportional Hazards model. In particular, we use the vaccine status of the individuals as the only covariate in the regression. Other confounders can be included as matching arguments to adjust for observational bias. The proportional hazards hypothesis is checked using the Schoenfeld test. A visual check is also provided using the log-log representation of the Survival Probability. If the hypothesis is not satisfied, it is recommended to stratify the population into smaller groups using the confounding variables.

## Data for Cohort design

Data disaggregated at the individual level to follow vaccinated and unvaccinated populations over time. The dataset must contain the following information:

- Date(s) of vaccination for each individual. The package allows working with multiple doses for each individual and estimates the immunization date using delay times of outcomes and immunization times of vaccines.

- Date(s) of outcome(s). The package estimates vaccine effectiveness against various outcomes.
Individuals' demographic information (e.g., sex, age-group, health status) can be specified depending on the confounding variables that will be introduced in the model.

## VE for Cohort design

The current release of the package bases the estimation of $VE$ in the cohort design on the assumption of proportional hazards between vaccinated and unvaccinated populations. The hazard ratio is estimated using the Cox proportional hazards model implemented in the R package `{survival}`.

The integrated dataset `cohortdata` serves as a minimal example of the package's input. The data is accessed using `data("cohortdata")`.

The following example estimates $VE$ by:

1. Defining the immunization information using the function `make_immunization()`. This method returns the cohort data with the immunization date based on the characteristic response time to vaccination (`immunization_delay`) and the specified limits (`outcome_date_col, censoring_date_col, end_cohort`).

2. Matching the cohort by exact and nearest confounders using the function `match_cohort()`. This function supports methods like `summary()` to check matching balance and the sizes of matched, excluded, and removed populations, and `get_dataset()` to extract the matched cohort.

3. Estimating $VE$ with the function `effectiveness()` using the hazard ratio ($HR$). A summary of the estimation can be obtained using `summary()` and a graphical representation of the methodology is generated by `plot().`


```{r cohortdata, include = TRUE, echo = TRUE}
# Load example data
data("cohortdata")

# Create `vaccineff_data`
vaccineff_data <- make_vaccineff_data(
  data_set = cohortdata,
  outcome_date_col = "death_date",
  censoring_date_col = "death_other_causes",
  vacc_date_col = "vaccine_date_2",
  vaccinated_status = "v",
  unvaccinated_status = "u",
  immunization_delay = 15,
  start_cohort = as.Date("2044-01-01"),
  end_cohort = as.Date("2044-12-31"),
  match = TRUE,
  exact = c("age", "sex"),
  nearest = NULL
)

# Print summary of vaccineff data object
summary(vaccineff_data)

# Estimate the Vaccine Effectiveness at 90 days
ve90 <- effectiveness(vaccineff_data, at = 90)

# Print summary of VE
summary(ve90)

# Loglog plot to check proportional hazards
plot(ve90, type = "loglog")

# Survival plot
plot(ve90, type = "surv", percentage = FALSE, cumulative = FALSE)
```

## References
